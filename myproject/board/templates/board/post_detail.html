{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="post-container">
    <div class="post-card">
        <h2>{{ post.title }}</h2>
        <p class="post-meta">
            ì‘ì„±ì: <strong>{{ post.author }}</strong> | ì‘ì„±ì¼: {{ post.created_at|date:"Y-m-d H:i" }}
        </p>

        {% if post.image %}
            <img src="{{ post.image.url }}" alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€" class="post-image">
        {% else %}
            <p>ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}

        <p class="post-content">{{ post.content }}</p>

        <!-- ì²¨ë¶€íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
        {% if post.attached_file %}
            <p class="attached-file">
                ğŸ“ <strong>ì²¨ë¶€ íŒŒì¼:</strong> 
                <a href="{{ post.attached_file.url }}" download class="btn-download">
                    {{ post.attached_file.name }}
                </a>
            </p>
        {% endif %}

        <!-- ì¢‹ì•„ìš” & ë¶ë§ˆí¬ ë²„íŠ¼ -->
        <div class="post-actions">
            <form action="{% url 'toggle_bookmark' post.id %}" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn {% if user in post.bookmarks.all %}btn-danger{% else %}btn-primary{% endif %}">
                    {% if user in post.bookmarks.all %}ğŸ“Œ ë¶ë§ˆí¬ ì·¨ì†Œ{% else %}ğŸ“Œ ë¶ë§ˆí¬ ì¶”ê°€{% endif %}
                </button>
            </form>

            <button id="like-btn" data-post-id="{{ post.id }}" class="btn btn-like">
                {% if user in post.likes.all %}â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ{% else %}ğŸ¤ ì¢‹ì•„ìš”{% endif %}
            </button>
            <span id="like-count">{{ post.likes.count }}</span>
        </div>

        <!-- ìˆ˜ì • & ì‚­ì œ ë²„íŠ¼ (ì‘ì„±ìë§Œ ë³´ì´ê²Œ) -->
        {% if user == post.author %}
        <div class="post-manage">
            <a href="{% url 'post_edit' post.id %}" class="btn-edit">ìˆ˜ì •</a>
            <a href="{% url 'post_delete' post.id %}" class="btn-delete">ì‚­ì œ</a>
        </div>
        {% endif %}
    </div>

    <!-- ğŸ”¹ ì¶”ì²œ ê²Œì‹œê¸€ ì„¹ì…˜ ì¶”ê°€ -->
    <div class="related-posts">
        <h3>ğŸ“¢ ì¶”ì²œ ê²Œì‹œê¸€</h3>
        <div class="post-grid">
            {% for related in related_posts %}
                <div class="post-card">
                    {% if related.image %}
                        <img src="{{ related.image.url }}" alt="ì¶”ì²œ ê²Œì‹œê¸€ ì´ë¯¸ì§€" class="post-image">
                    {% endif %}
                    <div class="post-content">
                        <h4><a href="{% url 'post_detail' related.id %}">{{ related.title }}</a></h4>
                        <p class="post-meta">ì‘ì„±ì: {{ related.author }} | ì¡°íšŒìˆ˜: {{ related.views }}</p>
                        <div class="post-tags">
                            {% for tag in related.tags.all %}
                                <a href="{% url 'post_list' %}>tag={{ tag.name }}" class="tag">{{ tag.name }}</a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <p>ì¶”ì²œí•  ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endfor %}
        </div>
    </div>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    <div class="comments-section">
        <h3>ğŸ’¬ ëŒ“ê¸€</h3>

        {% if post.comments.all %}
            {% for comment in post.comments.all %}
                <div class="comment-box">
                    <p><strong>{{ comment.author }}</strong>: {{ comment.content }}</p>
                    <small>{{ comment.created_at|date:"Y-m-d H:i" }}</small>

                    {% if user == comment.author %}
                    <div class="comment-actions">
                        <a href="{% url 'comment_edit' comment.id %}" class="btn-edit">ìˆ˜ì •</a>
                        <a href="{% url 'comment_delete' comment.id %}" class="btn-delete">ì‚­ì œ</a>
                    </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
        {% endif %}

        <!-- ëŒ“ê¸€ ì…ë ¥ í¼ -->
        {% if user.is_authenticated %}
        <div class="comment-form">
            <form method="post" action="{% url 'add_comment' post.id %}">
                {% csrf_token %}
                {{ comment_form.as_p }}
                <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
            </form>
        </div>
        {% else %}
        <p><a href="{% url 'login' %}">ë¡œê·¸ì¸</a> í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>

    <a href="{% url 'post_list' %}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
</div>

<!-- ì¢‹ì•„ìš” ê¸°ëŠ¥ JavaScript -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const likeBtn = document.getElementById("like-btn");
        const likeCount = document.getElementById("like-count");

        likeBtn.addEventListener("click", function() {
            const postId = likeBtn.getAttribute("data-post-id");

            fetch(`/board/post/${postId}/like/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                credentials: "same-origin"
            })
            .then(response => response.json())
            .then(data => {
                likeBtn.innerHTML = data.liked ? "â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ" : "ğŸ¤ ì¢‹ì•„ìš”";
                likeCount.textContent = data.total_likes;
            })
            .catch(error => console.error("Error:", error));
        });
    });
</script>
{% endblock %}