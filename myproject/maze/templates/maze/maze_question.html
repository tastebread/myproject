{% extends "base.html" %}
{% block title %}ë¯¸ê¶ ë¬¸ì œ{% endblock %}

{% block content %}
<div class="card">
    <!--<h2>ë¬¸ì œ {{ question.order }} ({{ question.get_level_display }})</h2>-->
    <h2>ë¯¸ê¶ íƒí—˜<h2>
    <!-- ìŠ¤í† ë¦¬ ì„¤ëª… í‘œì‹œ -->
    {% if question.story_text %}
    <p>{{ question.story_text|safe }}</p>
    {% endif %}
    <p>{{ question.question_text|safe }}</p>

    <!--ì´ë¯¸ì§€ê°€ ìˆì„ ê²½ìš°-->
    {% if question.image %}
        <img src="{{ question.image.url}}" alt="ë¬¸ì œ ì´ë¯¸ì§€" style="max-width:25%; height:auto;">
    {% endif %}

    <!-- ì ìˆ˜ í‘œì‹œ -->
    <p><strong>í˜„ì¬ ì ìˆ˜:</strong> <span id="current-score">{{ request.session.score|default:0 }}</span>ì </p>

    <!-- ì œí•œ ì‹œê°„ í‘œì‹œ -->
    <p><strong>ì œí•œ ì‹œê°„:</strong> <span id="timer">{{ question.time_limit }}</span>ì´ˆ</p>

    <form id="answer-form" method="POST" action="{% url 'submit_answer' %}">
        {% csrf_token %}
        <input type="text" name="answer" placeholder="ì •ë‹µ ì…ë ¥" required maxlength="100">
        <button type="submit" class="btn btn-primary">ì œì¶œ</button>
    </form>

    <button id="hint-btn" class="btn btn-secondary">ğŸ” íŒíŠ¸ ë³´ê¸°</button>
    <p id="hint-text"></p>
    
    <p id="feedback"></p>
</div>

<script>
    document.getElementById("answer-form").addEventListener("submit", function(event) {
        event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€
        
        let formData = new FormData(this);

        fetch(this.action, {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("feedback").innerHTML = data.message;
            document.getElementById("current-score").textContent = data.score;

            if (data.correct) {
                setTimeout (() => {
                    window.location.href = data.next_question_url; //ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
                }, 1000);
            }
        })
        .catch(error => console.error("ì •ë‹µ ì œì¶œ ì˜¤ë¥˜:", error));
    });

    document.getElementById("hint-btn").addEventListener("click", function() {
        this.disabled = true;
        fetch("{% url 'get_hint' %}")
        .then(response => response.json())
        .then(data => {
            document.getElementById("hint-text").innerHTML = "ğŸ’¡ íŒíŠ¸: " + data.hint;
        })
        .catch(error => console.error("íŒíŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
    });

    let timeRemaining = {{ question.time_limit }};
    const timerElement = document.getElementById("timer");

    if (timeRemaining > 0) {
        const timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        if (timeRemaining > 0) {
            timeRemaining--;
            timerElement.textContent = timeRemaining;
        } else {
            clearInterval(timerInterval);
            document.getElementById("feedback").innerHTML = "â³ ì œí•œ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤! ìë™ ì œì¶œí•©ë‹ˆë‹¤.";

            const answerInput = document.querySelector("input[name='answer']");
            if (answerInput.value.trim().length === 0) {
                answerInput.value = "ì‹œê°„ ì´ˆê³¼";
            }
            document.getElementById("answer-form").submit();
        }
    }
</script>
{% endblock %}